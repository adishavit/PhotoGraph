<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>PhotoGraph â€” Trip Mapper</title>

<!-- Leaflet -->
<link rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin="anonymous"></script>

<!-- exifr (lite) -->
<script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/lite.umd.js"
        integrity="sha256-jKg4u0Y/Tws6fZSJhDJJaQN8Xs8NsZTzEr1bvI+sE0c="
        crossorigin="anonymous"></script>

<style>
/* --- styles unchanged from your draft except minor cleanup --- */
:root {
  --blue:#007AFF; --bg:#f5f5f7; --text:#1d1d1f; --muted:#6e6e73;
  --card:#fff; --border:#d2d2d7; --warn:#ff9500; --ok:#34c759;
}
@media (prefers-color-scheme: dark) {
  :root { --bg:#1d1d1f; --text:#f5f5f7; --muted:#98989d; --card:#2c2c2e; --border:#3a3a3c; }
}
html,body{margin:0;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
#controls{background:var(--card);padding:16px;z-index:1000}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
.btn.primary{background:var(--blue);color:#fff}
.btn.secondary{background:var(--text);color:var(--bg)}
.btn:disabled{opacity:.4}
#fileInput{display:none}
.filters,.options{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
.filters input,.options select{padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--card);color:var(--text)}
.status{margin-top:10px;font-size:13px;color:var(--muted)}
progress{width:100%;height:6px}
#map{flex:1}
.tiny{font-size:12px;color:var(--muted)}
.success{color:var(--ok)} .warn{color:var(--warn)}
</style>
</head>

<body>
<div id="controls">
  <div class="row">
    <label class="btn primary" for="fileInput">ðŸ“¸ Choose photos</label>
    <button id="processBtn" class="btn secondary" disabled>Process</button>
    <button id="clearBtn" class="btn" disabled>Clear</button>
    <button id="shareBtn" class="btn" disabled>Share URL</button>
    <button id="gmapsBtn" class="btn" disabled>Google Maps</button>
    <button id="gpxBtn" class="btn" disabled>Export GPX</button>
    <span id="pickedInfo" class="tiny"></span>
  </div>

  <input id="fileInput" type="file" multiple accept="image/*"/>

  <div class="filters">
    <input type="datetime-local" id="startTime">
    <input type="datetime-local" id="endTime">
  </div>

  <div class="options">
    <label>Simplify:
      <select id="simplifySelect">
        <option value="light">Light</option>
        <option value="medium" selected>Medium</option>
        <option value="strong">Strong</option>
      </select>
    </label>
    <span class="tiny">Always snapped to roads (OSRM driving)</span>
  </div>

  <div class="status">
    <progress id="progress" value="0" max="100"></progress>
    <div id="statusLine">Choose photos to begin</div>
    <div id="statsLine" class="tiny"></div>
  </div>

  <div class="tiny">Photos stay local. Only coordinates are sent for routing.</div>
</div>

<div id="map"></div>

<script>
/* ========= configuration ========= */
const CFG = {
  OSRM_CHUNK: 80,
  OSRM_MAX: 350,
  SIMPLIFY: {light:12, medium:30, strong:70},
  SHARE_MAX: 200,
  GMAPS_MAX: 23
};

/* ========= map ========= */
const map = L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const photoLayer = L.layerGroup().addTo(map);
const pathLayer  = L.layerGroup().addTo(map);

/* ========= state ========= */
let files=[], photoPts=[], route=[];

/* ========= UI ========= */
const $=id=>document.getElementById(id);
$('fileInput').onchange=e=>{
  files=[...e.target.files];
  $('pickedInfo').textContent=files.length?`${files.length} selected`:'';
  $('processBtn').disabled=!files.length;
  $('clearBtn').disabled=!files.length;
};
$('clearBtn').onclick=()=>{location.hash='';location.reload()};
$('processBtn').onclick=process;

/* ========= main ========= */
async function process(){
  $('processBtn').disabled=true;
  photoPts=[]; route=[];
  photoLayer.clearLayers(); pathLayer.clearLayers();

  const start=$('startTime').value?new Date($('startTime').value):null;
  const end=$('endTime').value?new Date($('endTime').value):null;

  for(let i=0;i<files.length;i++){
    $('statusLine').textContent=`Reading ${i+1}/${files.length}`;
    const d=await exifr.parse(files[i],{gps:true});
    if(!d||!Number.isFinite(d.latitude)) continue;
    const t=new Date(d.DateTimeOriginal||d.CreateDate||files[i].lastModified);
    if(start&&t<start) continue;
    if(end&&t>end) continue;
    photoPts.push({lat:d.latitude,lng:d.longitude});
    $('progress').value=(i+1)/files.length*100;
  }

  if(photoPts.length<2){
    $('statusLine').textContent='Not enough GPS points';
    return;
  }

  photoPts.forEach((p,i)=>{
    L.circleMarker([p.lat,p.lng],{radius:i==0||i==photoPts.length-1?7:4})
      .addTo(photoLayer);
  });

  const simplified = simplify(photoPts.map(p=>[p.lat,p.lng]), $('simplifySelect').value);
  $('statusLine').textContent='Snapping to roadsâ€¦';

  try{
    route = await snapOSRM(simplified);
    draw(route);
    $('statusLine').innerHTML=`<span class="success">âœ“</span> Route mapped`;
  }catch{
    route = simplified;
    draw(route);
    $('statusLine').innerHTML=`<span class="warn">âš </span> Routing failed â€” fallback used`;
  }

  $('shareBtn').disabled=false;
  $('gmapsBtn').disabled=false;
  $('gpxBtn').disabled=false;
}

/* ========= snapping ========= */
async function snapOSRM(pts){
  if(pts.length>CFG.OSRM_MAX) pts=downsample(pts,CFG.OSRM_MAX);
  const out=[];
  for(let i=0;i<pts.length-1;i+=CFG.OSRM_CHUNK-1){
    const c=pts.slice(i,i+CFG.OSRM_CHUNK);
    const q=c.map(p=>`${p[1]},${p[0]}`).join(';');
    const r=await fetch(`https://router.project-osrm.org/route/v1/driving/${q}?overview=full&geometries=geojson`);
    const j=await r.json();
    const seg=j.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);
    if(out.length&&seg.length) seg.shift();
    out.push(...seg);
  }
  return out;
}

/* ========= draw ========= */
function draw(line){
  const pl=L.polyline(line,{color:'#007AFF',weight:4}).addTo(pathLayer);
  map.fitBounds(pl.getBounds(),{padding:[40,40]});
}

/* ========= simplify ========= */
function simplify(pts,level){
  const eps=CFG.SIMPLIFY[level];
  return pts.length>600?downsample(pts,600):pts;
}
function downsample(a,n){
  const r=[]; for(let i=0;i<n;i++) r.push(a[Math.round(i*(a.length-1)/(n-1))]);
  return r;
}

/* ========= share ========= */
$('shareBtn').onclick=()=>{
  const enc=encodePolyline(downsample(route,CFG.SHARE_MAX));
  location.hash='r='+btoa(enc);
  navigator.clipboard.writeText(location.href);
};

/* ========= polyline encode ========= */
function encodePolyline(coords){
  let r='',la=0,lo=0;
  for(const [lat,lng] of coords){
    let a=Math.round(lat*1e5)-la; la+=a;
    let b=Math.round(lng*1e5)-lo; lo+=b;
    r+=enc(a)+enc(b);
  }
  return r;
}
function enc(n){n=n<0?~(n<<1):(n<<1);let s='';while(n>=32){s+=String.fromCharCode((32|n&31)+63);n>>=5}return s+String.fromCharCode(n+63)}
</script>
</body>
</html>
